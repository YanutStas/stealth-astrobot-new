const createFeature = require("./featureFactory");

module.exports = (bot, flow) =>
  createFeature(bot, flow, {
    key: "love",
    buttonId: "love_start",
    label: "–∞–Ω–∞–ª–∏–∑ –ª—é–±–≤–∏ –∏ –æ—Ç–Ω–æ—à–µ–Ω–∏–π",
    price: 50,

    waitText: "üíå –ß–∏—Ç–∞—é –ª—é–±–æ–≤–Ω—ã–µ –ª–∏–Ω–∏–∏‚Ä¶",
    hintText:
      "‚ùó –¢—Ä–∏ —Å—Ç—Ä–æ–∫–∏:\n1) üìÖ –î–∞—Ç–∞ ‚è∞ –í—Ä–µ–º—è üó∫ –ì–æ—Ä–æ–¥\n2) üíñ –°—Ç–∞—Ç—É—Å\n3) ‚ùì –í–æ–ø—Ä–æ—Å",
    askText:
      "‚ú® –û–ø–ª–∞—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞!\n\n" +
      "–î–ª—è *–∞–Ω–∞–ª–∏–∑–∞ –ª—é–±–≤–∏ –∏ –æ—Ç–Ω–æ—à–µ–Ω–∏–π* –ø—Ä–∏—à–ª–∏:\n" +
      "1) üìÖ –î–∞—Ç–∞ ‚è∞ –í—Ä–µ–º—è üó∫ –ì–æ—Ä–æ–¥\n" +
      "2) üíñ –°–µ–º–µ–π–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ\n" +
      "3) ‚ùì –ß—Ç–æ –≤–æ–ª–Ω—É–µ—Ç\n\n" +
      "–ü—Ä–∏–º–µ—Ä:\n1) 01.01.2000 10:00 –ú–æ—Å–∫–≤–∞\n2) –≤—Å—Ç—Ä–µ—á–∞—é—Å—å\n3) –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö?",

    regExp:
      /^\s*(?:1\)\s*)?(\d{2}\.\d{2}\.\d{4}\s+\d{2}:\d{2}\s+.+?)\s*(?:\r?\n|\r)\s*(?:2\)\s*)?(.+?)\s*(?:\r?\n|\r)\s*(?:3\)\s*)?(.+)$/,

    sysMsg:
      "–û—Ç–≤–µ—á–∞–π 5 –±–ª–æ–∫–∞–º–∏: –ª–∏—á–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è, —ç–º–æ—Ü–∏–∏, –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª, –ø—Ä–æ–±–ª–µ–º—ã, —Å–æ–≤–µ—Ç. ‚â§1200 —Å–∏–º–≤–æ–ª–æ–≤.",

    buildPrompt: ([, birth, status, what]) =>
      `
–°–¥–µ–ª–∞–π –∞–Ω–∞–ª–∏–∑ –ª—é–±–≤–∏ –∏ –æ—Ç–Ω–æ—à–µ–Ω–∏–π –ø–æ 5 –±–ª–æ–∫–∞–º:

1. ‚ù§Ô∏è –õ–∏—á–Ω–∞—è –ª—é–±–æ–≤—å-—ç–Ω–µ—Ä–≥–∏—è  
2. üíû –≠–º–æ—Ü–∏–∏ / –≤—ã—Ä–∞–∂–µ–Ω–∏–µ —á—É–≤—Å—Ç–≤  
3. üíç –ü–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∏–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª  
4. ‚ö†Ô∏è –¢–æ—á–∫–∏ —Ä–æ—Å—Ç–∞ / –ø—Ä–æ–±–ª–µ–º—ã  
5. ‚ú® –°–æ–≤–µ—Ç –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–π –≥–æ–¥  

–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è: ${birth.trim()}  
–°–µ–º–µ–π–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ: ${status.trim()}  
–ß—Ç–æ –≤–æ–ª–Ω—É–µ—Ç: ${what.trim()}`.trim(),
  });

// const { Markup } = require("telegraf");
// const axios = require("axios");
// const logger = require("../../../logger");
// const MODELS = require("../../../models");
// const pending = require("../../pendingStore");

// const feature = "love";

// module.exports = (bot, flow) => {
//   const label = "–∞–Ω–∞–ª–∏–∑ –ª—é–±–≤–∏ –∏ –æ—Ç–Ω–æ—à–µ–Ω–∏–π";

//   bot.action("love_start", async (ctx) => {
//     await ctx.answerCbQuery();
//     flow.set(ctx.from.id, feature);

//     pending.set(ctx.from.id, {
//       label,
//       ask:
//         "‚ú® –û–ø–ª–∞—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞!\n\n" +
//         "–î–ª—è *–∞–Ω–∞–ª–∏–∑–∞ –ª—é–±–≤–∏ –∏ –æ—Ç–Ω–æ—à–µ–Ω–∏–π* –ø—Ä–∏—à–ª–∏ —Ç—Ä–µ–º—è —Å—Ç—Ä–æ–∫–∞–º–∏:\n" +
//         "1) üìÖ –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è ‚è∞ –í—Ä–µ–º—è üó∫ –ì–æ—Ä–æ–¥\n" +
//         "2) üíñ –°–µ–º–µ–π–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ (—Å–≤–æ–±–æ–¥–Ω–∞, –∑–∞–º—É–∂–µ–º –∏ —Ç.–¥.)\n" +
//         "3) ‚ùì –ß—Ç–æ –≤–æ–ª–Ω—É–µ—Ç (1-2 —Ñ—Ä–∞–∑—ã)\n" +
//         "–ü—Ä–∏–º–µ—Ä:\n" +
//         "1) 01.01.2000 10:00 –ú–æ—Å–∫–≤–∞\n" +
//         "2) –≤—Å—Ç—Ä–µ—á–∞—é—Å—å\n" +
//         "3) –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö?",
//     });

//     await ctx.reply(
//       `üí≥ –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è *${label}* –ø–µ—Ä–µ–≤–µ–¥–∏ 50 ‚ÇΩ –Ω–∞ –∫–∞—Ä—Ç—É:\n` +
//         "2200 7009 7760 7737\n\n–ó–∞—Ç–µ–º –ø—Ä–∏—à–ª–∏ —Å–∫—Ä–∏–Ω—à–æ—Ç —á–µ–∫–∞ üëá",
//       { parse_mode: "Markdown" }
//     );
//   });

//   const loveReg =
//     /^\s*(?:1\)\s*)?(\d{2}\.\d{2}\.\d{4}\s+\d{2}:\d{2}\s+.+?)\s*(?:\r?\n|\r)\s*(?:2\)\s*)?(.+?)\s*(?:\r?\n|\r)\s*(?:3\)\s*)?(.+)$/;

//   // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–º–µ—Å—Ç–æ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ
//   bot.hears(
//     (text, ctx) => flow.get(ctx.from.id) === feature && loveReg.test(text),
//     async (ctx) => {
//       const match = ctx.message.text.match(loveReg);
//       if (!match) {
//         logger.warn("[love] –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ");
//         return;
//       }

//       const [, birth, status, concern] = match;
//       const t0 = Date.now();
//       const tag = ctx.from.username || ctx.from.id;
//       logger.info(`[love] –∑–∞–ø—Ä–æ—Å @${tag}`);

//       await ctx.reply("üíå –ß–∏—Ç–∞—é –ª—é–±–æ–≤–Ω—ã–µ –ª–∏–Ω–∏–∏‚Ä¶");

//       const userPrompt = `–°–¥–µ–ª–∞–π –∞–Ω–∞–ª–∏–∑ –ª—é–±–≤–∏ –∏ –æ—Ç–Ω–æ—à–µ–Ω–∏–π –ø–æ 5 –±–ª–æ–∫–∞–º:

// 1. ‚ù§Ô∏è –õ–∏—á–Ω–∞—è –ª—é–±–æ–≤—å-—ç–Ω–µ—Ä–≥–∏—è
// 2. üíû –≠–º–æ—Ü–∏–∏ / –≤—ã—Ä–∞–∂–µ–Ω–∏–µ —á—É–≤—Å—Ç–≤
// 3. üíç –ü–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∏–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª
// 4. ‚ö†Ô∏è –¢–æ—á–∫–∏ —Ä–æ—Å—Ç–∞ / –ø—Ä–æ–±–ª–µ–º—ã
// 5. ‚ú® –°–æ–≤–µ—Ç –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–π –≥–æ–¥

// –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è: ${birth.trim()}
// –°–µ–º–µ–π–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ: ${status.trim()}
// –ß—Ç–æ –≤–æ–ª–Ω—É–µ—Ç: ${concern.trim()}`;

//       for (const model of MODELS) {
//         try {
//           const { data } = await axios.post(
//             "https://openrouter.ai/api/v1/chat/completions",
//             {
//               model,
//               messages: [
//                 {
//                   role: "system",
//                   content:
//                     "–¢—ã –º—è–≥–∫–∏–π –∞—Å—Ç—Ä–æ–ª–æ–≥-–∫–æ—É—á. –û—Ç–≤–µ—á–∞–π —Å—Ç—Ä–æ–≥–æ 5 –±–ª–æ–∫–∞–º–∏: 1. –õ–∏—á–Ω–∞—è –ª—é–±–æ–≤—å-—ç–Ω–µ—Ä–≥–∏—è, 2. –≠–º–æ—Ü–∏–∏/–≤—ã—Ä–∞–∂–µ–Ω–∏–µ —á—É–≤—Å—Ç–≤, 3. –ü–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∏–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª, 4. –¢–æ—á–∫–∏ —Ä–æ—Å—Ç–∞/–ø—Ä–æ–±–ª–µ–º—ã, 5. –°–æ–≤–µ—Ç –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–π –≥–æ–¥. " +
//                     "–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Å–∏–º–≤–æ–ª—ã ¬´#¬ª –≤ –Ω–∞—á–∞–ª–µ –±–ª–æ–∫–æ–≤, ‚â§1200 —Å–∏–º–≤–æ–ª–æ–≤, —Ç—ë–ø–ª—ã–π —Ä—É—Å—Å–∫–∏–π, —ç–º–æ–¥–∑–∏ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é—Ç—Å—è. –£—á–∏—Ç—ã–≤–∞–π, —á—Ç–æ —Å–µ–π—á–∞—Å 2025 –≥–æ–¥. " +
//                     "–ó–∞–ø—Ä–µ—â–µ–Ω–æ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞—Ç—å —Å–º–µ—Ä—Ç—å, –±–æ–ª–µ–∑–Ω–∏ –∏ –¥–∞–≤–∞—Ç—å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Å–æ–≤–µ—Ç—ã.",
//                 },
//                 { role: "user", content: userPrompt },
//               ],
//             },
//             {
//               headers: {
//                 Authorization: `Bearer ${process.env.OPENROUTER_API_KEY}`,
//                 "Content-Type": "application/json",
//               },
//             }
//           );

//           const answer = (data.choices?.[0]?.message?.content || "").trim();
//           await ctx.reply(
//             answer || "üåå –ö–æ—Å–º–æ—Å –º–æ–ª—á–∏—Ç.",
//             Markup.inlineKeyboard([
//               [Markup.button.callback("–ù–∞–∑–∞–¥ ‚óÄÔ∏è", "back_to_menu")],
//             ])
//           );

//           logger.info(`[love] ok ${model} ${Date.now() - t0}–º—Å`);
//           pending.delete(ctx.from.id);
//           flow.delete(ctx.from.id);
//           return;
//         } catch (e) {
//           logger.warn(`[love] FAIL ${model} | ${e.code || e.response?.status}`);
//         }
//       }

//       await ctx.reply(
//         "üõ†Ô∏è –í–µ–Ω–µ—Ä–∞ –≤ —Ç—É—á–∞—Ö. –ü–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ.",
//         Markup.inlineKeyboard([
//           [Markup.button.callback("–ù–∞–∑–∞–¥ ‚óÄÔ∏è", "back_to_menu")],
//         ])
//       );
//       pending.delete(ctx.from.id);
//       flow.delete(ctx.from.id);
//     }
//   );

//   /* --- –Ω–∞–π–¥–∏—Ç–µ –≤ love.js –±–ª–æ–∫ —Å bot.on("message") –∏ –∑–∞–º–µ–Ω–∏—Ç–µ –µ–≥–æ —Ü–µ–ª–∏–∫–æ–º --- */
//   bot.on("message", async (ctx, next) => {
//     if (flow.get(ctx.from.id) === feature) {
//       await ctx.reply(
//         "‚ùó –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–∏—à–ª–∏ –¥–∞–Ω–Ω—ã–µ —Ä–æ–≤–Ω–æ –≤ —Ç—Ä—ë—Ö —Å—Ç—Ä–æ–∫–∞—Ö:\n" +
//           "1) üìÖ –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è ‚è∞ –í—Ä–µ–º—è üó∫ –ì–æ—Ä–æ–¥\n" +
//           "2) üíñ –°–µ–º–µ–π–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ (1‚Äì2 —Å–ª–æ–≤–∞)\n" +
//           "3) ‚ùì –ß—Ç–æ –≤–æ–ª–Ω—É–µ—Ç (1‚Äì2 —Ñ—Ä–∞–∑—ã)\n\n" +
//           "–ü—Ä–∏–º–µ—Ä:\n" +
//           "1) 01.01.2000 10:00 –ú–æ—Å–∫–≤–∞\n" +
//           "2) –≤—Å—Ç—Ä–µ—á–∞—é—Å—å\n" +
//           "3) –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö?",
//         Markup.inlineKeyboard([
//           [Markup.button.callback("–ù–∞–∑–∞–¥ ‚óÄÔ∏è", "back_to_menu")],
//         ])
//       );
//       // –æ—Å—Ç–∞—ë–º—Å—è –≤ —Ä–µ–∂–∏–º–µ love, next –Ω–µ –Ω—É–∂–µ–Ω
//       return;
//     }
//     /* –µ—Å–ª–∏ —Ä–µ–∂–∏–º –¥—Ä—É–≥–æ–π ‚Äî –æ—Ç–¥–∞—ë–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–ª—å—à–µ */
//     return next();
//   });
// };
