const { Markup } = require("telegraf");
const axios = require("axios");
const logger = require("../../../logger");
const MODELS = require("../../../models");
const pending = require("../../pendingStore");

// feature-—Ñ–ª–∞–≥ –¥–ª—è —Ä–µ–∂–∏–º–∞ ¬´–ª—é–±–æ–≤—å¬ª
const feature = "love";

module.exports = (bot, flow) => {
  const label = "–∞–Ω–∞–ª–∏–∑ –ª—é–±–≤–∏ –∏ –æ—Ç–Ω–æ—à–µ–Ω–∏–π";

  // 1) –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ ¬´üíï –õ—é–±–æ–≤—å (–ø–ª–∞—Ç–Ω–æ)¬ª
  bot.action("love_start", async (ctx) => {
    await ctx.answerCbQuery();
    // –í–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º ¬´love¬ª
    flow.set(ctx.from.id, feature);

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º ¬´pending¬ª —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ —á–µ–∫ + –¥–∞–ª—å–Ω–µ–π—à–∏–π –≤–≤–æ–¥
    pending.set(ctx.from.id, {
      label,
      ask:
        "‚ú® –û–ø–ª–∞—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞!\n\n" +
        "–î–ª—è *–∞–Ω–∞–ª–∏–∑–∞ –ª—é–±–≤–∏ –∏ –æ—Ç–Ω–æ—à–µ–Ω–∏–π* –ø—Ä–∏—à–ª–∏ —Ç—Ä–µ–º—è —Å—Ç—Ä–æ–∫–∞–º–∏:\n" +
        "1) üìÖ –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è ‚è∞ –í—Ä–µ–º—è üó∫ –ì–æ—Ä–æ–¥\n" +
        "2) üíñ –°–µ–º–µ–π–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ (—Å–≤–æ–±–æ–¥–Ω–∞, –∑–∞–º—É–∂–µ–º –∏ —Ç.–¥.)\n" +
        "3) ‚ùì –ß—Ç–æ –≤–æ–ª–Ω—É–µ—Ç (1-2 —Ñ—Ä–∞–∑—ã)\n" +
        "–ü—Ä–∏–º–µ—Ä:\n" +
        "1) 01.01.2000 10:00 –ú–æ—Å–∫–≤–∞\n" +
        "2) –≤—Å—Ç—Ä–µ—á–∞—é—Å—å\n" +
        "3) –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö?",
    });

    await ctx.reply(
      `üí≥ –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è *${label}* –ø–µ—Ä–µ–≤–µ–¥–∏ 50 ‚ÇΩ –Ω–∞ –∫–∞—Ä—Ç—É:\n` +
        "2200 7009 7760 7737\n\n–ó–∞—Ç–µ–º –ø—Ä–∏—à–ª–∏ —Å–∫—Ä–∏–Ω—à–æ—Ç —á–µ–∫–∞ üëá",
      { parse_mode: "Markdown" }
    );
  });

  // 2) –†–µ–≥—É–ª—è—Ä–∫–∞: —Ç—Ä–∏ —Å—Ç—Ä–æ–∫–∏ (–¥–∞—Ç–∞/–≤—Ä–µ–º—è/–≥–æ—Ä–æ–¥ ‚Äî —Å–µ–º–µ–π–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ ‚Äî —á—Ç–æ –≤–æ–ª–Ω—É–µ—Ç)
  const loveReg =
    /^\s*(?:1\)\s*)?(\d{2}\.\d{2}\.\d{4}\s+\d{2}:\d{2}\s+.+?)\s*(?:\r?\n|\r)\s*(?:2\)\s*)?(.+?)\s*(?:\r?\n|\r)\s*(?:3\)\s*)?(.+)$/;

  // 3) –û—Å–Ω–æ–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫: –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ —Ä–µ–∂–∏–º–µ ¬´love¬ª –∏ —Ç–µ–∫—Å—Ç –ø–æ–¥—Ö–æ–¥–∏—Ç –ø–æ–¥ loveReg
  bot.hears(async (txt, ctx) => {
    return flow.get(ctx.from.id) === feature && loveReg.test(ctx.message.text);
  }, async (ctx) => {
    // –ó–∞–±–∏—Ä–∞–µ–º –≥—Ä—É–ø–ø—ã –∏–∑ —Ä–µ–≥—É–ª—è—Ä–∫–∏
    const [, birth, status, concern] = ctx.message.text.match(loveReg);

    const t0 = Date.now();
    const tag = ctx.from.username || ctx.from.id;
    logger.info(`[love] –∑–∞–ø—Ä–æ—Å @${tag}`);

    await ctx.reply("üíå –ß–∏—Ç–∞—é –ª—é–±–æ–≤–Ω—ã–µ –ª–∏–Ω–∏–∏‚Ä¶");

    // –°–æ–±–∏—Ä–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç
    const userPrompt = `–°–¥–µ–ª–∞–π –∞–Ω–∞–ª–∏–∑ –ª—é–±–≤–∏ –∏ –æ—Ç–Ω–æ—à–µ–Ω–∏–π –ø–æ 5 –±–ª–æ–∫–∞–º:

1. ‚ù§Ô∏è –õ–∏—á–Ω–∞—è –ª—é–±–æ–≤—å-—ç–Ω–µ—Ä–≥–∏—è  
2. üíû –≠–º–æ—Ü–∏–∏ / –≤—ã—Ä–∞–∂–µ–Ω–∏–µ —á—É–≤—Å—Ç–≤  
3. üíç –ü–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∏–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª  
4. ‚ö†Ô∏è –¢–æ—á–∫–∏ —Ä–æ—Å—Ç–∞ / –ø—Ä–æ–±–ª–µ–º—ã  
5. ‚ú® –°–æ–≤–µ—Ç –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–π –≥–æ–¥  

–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è: ${birth.trim()}  
–°–µ–º–µ–π–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ: ${status.trim()}  
–ß—Ç–æ –≤–æ–ª–Ω—É–µ—Ç: ${concern.trim()}`;

    // –ü—Ä–æ–±—É–µ–º –≤—Å–µ –º–æ–¥–µ–ª–∏ –ø–æ –æ—á–µ—Ä–µ–¥–∏
    for (const model of MODELS) {
      try {
        const { data } = await axios.post(
          "https://openrouter.ai/api/v1/chat/completions",
          {
            model,
            messages: [
              {
                role: "system",
                content:
                  "–¢—ã –º—è–≥–∫–∏–π –∞—Å—Ç—Ä–æ–ª–æ–≥-–∫–æ—É—á. –û—Ç–≤–µ—á–∞–π —Å—Ç—Ä–æ–≥–æ 5 –±–ª–æ–∫–∞–º–∏: 1. –õ–∏—á–Ω–∞—è –ª—é–±–æ–≤—å-—ç–Ω–µ—Ä–≥–∏—è, 2. –≠–º–æ—Ü–∏–∏/–≤—ã—Ä–∞–∂–µ–Ω–∏–µ —á—É–≤—Å—Ç–≤, 3. –ü–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∏–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª, 4. –¢–æ—á–∫–∏ —Ä–æ—Å—Ç–∞/–ø—Ä–æ–±–ª–µ–º—ã, 5. –°–æ–≤–µ—Ç –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–π –≥–æ–¥. " +
                  "–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Å–∏–º–≤–æ–ª—ã ¬´#¬ª –≤ –Ω–∞—á–∞–ª–µ –±–ª–æ–∫–æ–≤, ‚â§1200 —Å–∏–º–≤–æ–ª–æ–≤, —Ç—ë–ø–ª—ã–π —Ä—É—Å—Å–∫–∏–π, —ç–º–æ–¥–∑–∏ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é—Ç—Å—è. –£—á–∏—Ç—ã–≤–∞–π, —á—Ç–æ —Å–µ–π—á–∞—Å 2025 –≥–æ–¥. " +
                  "–ó–∞–ø—Ä–µ—â–µ–Ω–æ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞—Ç—å —Å–º–µ—Ä—Ç—å, –±–æ–ª–µ–∑–Ω–∏ –∏ –¥–∞–≤–∞—Ç—å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Å–æ–≤–µ—Ç—ã.",
              },
              { role: "user", content: userPrompt },
            ],
          },
          {
            headers: {
              Authorization: `Bearer ${process.env.OPENROUTER_API_KEY}`,
              "Content-Type": "application/json",
            },
          }
        );

        // –ë–µ—Ä—ë–º –æ—Ç–≤–µ—Ç –æ—Ç GPT
        const answer = (data.choices?.[0]?.message?.content || "").trim();

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é + –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∫–Ω–æ–ø–∫—É ¬´–ù–∞–∑–∞–¥ ‚óÄÔ∏è¬ª
        await ctx.reply(
          answer || "üåå –ö–æ—Å–º–æ—Å –º–æ–ª—á–∏—Ç.",
          Markup.inlineKeyboard([[Markup.button.callback("–ù–∞–∑–∞–¥ ‚óÄÔ∏è", "back_to_menu")]])
        );

        logger.info(`[love] ok ${model} ${Date.now() - t0}–º—Å`);

        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–µ–∂–∏–º ¬´love¬ª –∏ pending
        pending.delete(ctx.from.id);
        flow.delete(ctx.from.id);
        return;
      } catch (e) {
        logger.warn(`[love] FAIL ${model} | ${e.code || e.response?.status}`);
      }
    }

    // –ï—Å–ª–∏ –≤—Å–µ –º–æ–¥–µ–ª–∏ —É–ø–∞–ª–∏
    await ctx.reply(
      "üõ†Ô∏è –í–µ–Ω–µ—Ä–∞ –≤ —Ç—É—á–∞—Ö. –ü–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ.",
      Markup.inlineKeyboard([[Markup.button.callback("–ù–∞–∑–∞–¥ ‚óÄÔ∏è", "back_to_menu")]])
    );
    pending.delete(ctx.from.id);
    flow.delete(ctx.from.id);
  });

  // 4) –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ —Ä–µ–∂–∏–º–µ ¬´love¬ª, –Ω–æ –æ—Ç–ø—Ä–∞–≤–∏–ª —á—Ç–æ-—Ç–æ, —á—Ç–æ –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –ø–æ–¥ —Ä–µ–≥—ç–∫—Å–ø
  bot.on("message", async (ctx) => {
    if (flow.get(ctx.from.id) === feature) {
      // –ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–æ–º–Ω–∏–º —Ñ–æ—Ä–º–∞—Ç –∏ —Å–±—Ä–æ—Å–∏–º —Ä–µ–∂–∏–º
      await ctx.reply(
        "‚ùó –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–∏—à–ª–∏ –¥–∞–Ω–Ω—ã–µ —Ä–æ–≤–Ω–æ –≤ —Ç—Ä—ë—Ö —Å—Ç—Ä–æ–∫–∞—Ö:\n" +
          "1) üìÖ –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è ‚è∞ –í—Ä–µ–º—è üó∫ –ì–æ—Ä–æ–¥\n" +
          "2) üíñ –°–µ–º–µ–π–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ (1‚Äì2 —Å–ª–æ–≤–∞)\n" +
          "3) ‚ùì –ß—Ç–æ –≤–æ–ª–Ω—É–µ—Ç (1‚Äì2 —Ñ—Ä–∞–∑—ã)\n\n" +
          "–ü—Ä–∏–º–µ—Ä:\n" +
          "1) 01.01.2000 10:00 –ú–æ—Å–∫–≤–∞\n" +
          "2) –≤—Å—Ç—Ä–µ—á–∞—é—Å—å\n" +
          "3) –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö?",
        Markup.inlineKeyboard([[Markup.button.callback("–ù–∞–∑–∞–¥ ‚óÄÔ∏è", "back_to_menu")]])
      );
      flow.delete(ctx.from.id);
      pending.delete(ctx.from.id);
    }
  });
};